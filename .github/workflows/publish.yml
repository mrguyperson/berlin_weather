name: Update Weather and Publish

on:
  # Manual run
  workflow_dispatch:

  # Daily schedule
  schedule:
    - cron: "0 3 * * *"

  # Publish automatically when the image finishes building
  workflow_run:
    workflows: ["Build Weather Image"]
    types: [completed]

  # Always try publishing on push
  push:
    branches: ["main"]

jobs:
  publish:
    # Logic:
    # 1. Run if this is a push
    # 2. Run if this is a schedule
    # 3. Run if manually dispatched
    # 4. Run after Build Image ONLY if the build succeeded
    if: >
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')

    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: read

    container:
      image: ghcr.io/${{ github.repository_owner }}/weather-image:latest
      options: --user root

    env:
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      QUARTO_PUB_AUTH_TOKEN: ${{ secrets.QUARTO_PUB_AUTH_TOKEN }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Update weather
        run: Rscript scripts/update_weather_data.R

      - name: Build targets pipeline
        run: Rscript -e 'targets::tar_make()'

      - name: Publish dashboard
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: quarto-pub
