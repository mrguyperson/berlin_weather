on:
  workflow_dispatch:
  push:
    branches: main
  schedule:
    - cron: '0 3 * * *'  # Run daily at 03:00 UTC

name: Quarto Publish

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      QUARTO_PUB_AUTH_TOKEN: ${{ secrets.QUARTO_PUB_AUTH_TOKEN }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # --- Detect Ubuntu codename and set RSPM dynamically ---
      - name: Detect Ubuntu codename and set RSPM
        id: detect-rspm
        run: |
          CODENAME=$(lsb_release -cs)
          SNAPSHOT_DATE="2025-02-28"
          echo "Detected Ubuntu codename: $CODENAME"
          echo "RSPM=https://packagemanager.posit.co/cran/__linux__/${CODENAME}/${SNAPSHOT_DATE}" >> $GITHUB_ENV

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            gdal-bin libgdal-dev libgeos-dev libglpk-dev \
            libnode-dev libproj-dev libsqlite3-dev libudunits2-dev

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 4.4.3
          use-public-rspm: true

      # --- Restore caches (pak + R library) ---
      - name: Restore pak cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/R/pak
            ~/.cache/R/pak
          key: ${{ runner.os }}-pak-${{ hashFiles('**/DESCRIPTION', '**/*.R', '**/*.Rmd', '**/*.qmd', '**/*.yml') }}
          restore-keys: |
            ${{ runner.os }}-pak-

      - name: Restore R library cache
        uses: actions/cache@v4
        with:
          path: ~/R
          key: ${{ runner.os }}-rlib-${{ hashFiles('**/DESCRIPTION', '**/*.R', '**/*.Rmd', '**/*.qmd', '**/*.yml') }}
          restore-keys: |
            ${{ runner.os }}-rlib-

      # --- Install R packages using pak binaries ---
      - name: Install R packages via pak (binary mode)
        run: |
          # Make sure all R sessions share the same CRAN mirror
          echo "options(repos = c(CRAN='${RSPM}'))" >> ~/.Rprofile

          # Install pak if not cached
          Rscript -e 'if (!"pak" %in% rownames(installed.packages())) install.packages("pak", repos="https://cloud.r-project.org")'

          # Use pak to install dependencies from binaries
          Rscript -e '
            Sys.setenv(RSPM = Sys.getenv("RSPM"))
            pak::pak(c(
              "here","tidyverse","targets","readxl","tarchetypes",
              "showtext","openmeteo","gt","leaflet","bigrquery"
            ))
          '

      # --- Save caches back (pak + R library) ---
      - name: Save pak cache
        if: success()
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/R/pak
            ~/.cache/R/pak
          key: ${{ runner.os }}-pak-${{ hashFiles('**/DESCRIPTION', '**/*.R', '**/*.Rmd', '**/*.qmd', '**/*.yml') }}

      - name: Save R library cache
        if: success()
        uses: actions/cache@v4
        with:
          path: ~/R
          key: ${{ runner.os }}-rlib-${{ hashFiles('**/DESCRIPTION', '**/*.R', '**/*.Rmd', '**/*.qmd', '**/*.yml') }}

      # --- Automatic cache cleanup (uses GitHub CLI) ---
      - name: Clean up old caches
        if: always()
        run: |
          echo "Checking for old caches to delete..."
          gh cache list --sort created_at --limit 100 |
            awk 'NR>5 {print $1}' |
            xargs -r -n1 gh cache delete || true
        env:
          GH_TOKEN: ${{ github.token }}

      # # --- Build pipeline and publish dashboard ---
      # - name: Update weather data in BigQuery
      #   run: Rscript scripts/update_weather_data.R

      # - name: Run targets pipeline
      #   run: Rscript -e 'targets::tar_make()'

      # - name: Set up Quarto
      #   uses: quarto-dev/quarto-actions/setup@v2

      # - name: Render and Publish
      #   uses: quarto-dev/quarto-actions/publish@v2
      #   with:
      #     target: quarto-pub
