name: Weather Dashboard Publish

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 3 * * *"    # run daily at 03:00 UTC

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    # ------------------------------------------------------------
    # Use your custom Docker image for a reproducible environment
    # ------------------------------------------------------------
    container:
      image: ghcr.io/${{ github.repository_owner }}/weather-image:latest
      options: --user root

    env:
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      QUARTO_PUB_AUTH_TOKEN: ${{ secrets.QUARTO_PUB_AUTH_TOKEN }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Update BigQuery with new weather data
      # ------------------------------------------------------------
      - name: Update weather observations
        run: Rscript scripts/update_weather_data.R

      # ------------------------------------------------------------
      # Build your analysis pipeline
      # ------------------------------------------------------------
      - name: Run targets pipeline
        run: Rscript -e 'targets::tar_make()'

      # ------------------------------------------------------------
      # Publish dashboard to Quarto Pub
      # (includes render automatically)
      # ------------------------------------------------------------
      - name: Publish dashboard
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: quarto-pub
