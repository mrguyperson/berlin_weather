name: Update Weather and Publish

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
  workflow_run:
    workflows: ["Build Weather Image"]
    types: [completed]

jobs:
  publish:
    if: >
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')

    runs-on: ubuntu-latest

    container:
      image: ghcr.io/${{ github.repository_owner }}/weather-image:latest
      options: --user root

    env:
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      QUARTO_PUB_AUTH_TOKEN: ${{ secrets.QUARTO_PUB_AUTH_TOKEN }}

    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Update weather
        run: Rscript scripts/update_weather_data.R

      - name: Run targets pipeline
        run: Rscript -e 'targets::tar_make()'

      - name: Publish dashboard
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: quarto-pub